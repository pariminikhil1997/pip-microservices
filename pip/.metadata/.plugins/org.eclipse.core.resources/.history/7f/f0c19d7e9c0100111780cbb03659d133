package com.java.pip.service;

import java.util.List;

import org.springframework.cache.annotation.Cacheable;
import org.springframework.stereotype.Service;

import com.java.pip.dto.ProductRequestDTO;
import com.java.pip.dto.ProductResponseDTO;
import com.java.pip.entity.Product;
import com.java.pip.exception.ResourceNotFoundException;
import com.java.pip.repository.ProductRepository;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Service
@RequiredArgsConstructor
@Slf4j
public class ProductServiceImpl implements ProductService {
	
	private final ProductRepository productRepository;
	
	private ProductResponseDTO map(Product product) {
		
		return new ProductResponseDTO(product.getId(), product.getName(), product.getPrice());
	}

	@Override
	public ProductResponseDTO createProduct(ProductRequestDTO dTO) {
		log.debug("In service layer creating product with name: {}", dTO.name());
		Product product = productRepository.save(new Product(null, dTO.name(), dTO.price()));
		return map(product);
	}

	@Cacheable(value = "products", key = "#id")
	public ProductResponseDTO getProductById(Long id) {
		log.debug("In service layer Fetching product with id: {}", id);
		Product product = productRepository.findById(id)
		   .orElseThrow(() -> new ResourceNotFoundException("Product not found with id: "+id));
		return map(product);
	}

	@Override
	@CacheEvict(value = "products", key = "#id")
	public ProductResponseDTO updateProduct(Long id, ProductRequestDTO productRequestDTO) {
		log.debug("In service layer updating product with id: {}", id);
		Product product = productRepository.findById(id)
		                                   .orElseThrow(() -> new ResourceNotFoundException("Product not found with id: "+id));
		product.setName(productRequestDTO.name());
		product.setPrice(productRequestDTO.price());
		return map(productRepository.save(product));
	}

	@Override
	public List<ProductResponseDTO> getallProducts() {
		log.debug("In service layer fetching all products");
		return productRepository.findAll().stream().map(this::map).toList();
	}

	@Override
	public void deleteProduct(Long id) {
		log.debug("In service layer deleting product with id: {}", id);
		if(!productRepository.existsById(id)) {
			throw new ResourceNotFoundException("Product not found with id: "+id);
		}
		productRepository.deleteById(id);
	}
}